apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "pwa-infra.fullname" . }}-nginx-config
  labels: {{ include "pwa-infra.labels" . | nindent 4 }}
data:
  nginx.conf: |
    pid /tmp/nginx.pid;

    events {
        worker_connections 1024;
    }

    http {
        client_body_temp_path /tmp/client_temp;
        proxy_temp_path /tmp/proxy_temp;

        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        # Hide nginx version in error pages and headers
        server_tokens off;
        
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        
        gzip on; 
        gzip_vary on; 
        gzip_min_length 1024; 
        gzip_proxied any; 
        gzip_types
            text/css
            text/plain
            text/javascript
            application/javascript
            application/json
            application/x-javascript
            application/xml
            application/xml+rss
            application/xhtml+xml
            application/x-font-ttf
            application/x-font-opentype
            application/vnd.ms-fontobject
            image/svg+xml
            image/x-icon
            application/rss+xml
            application/atom_xml;
            gzip_disable "MSIE [1-6]\.";

        log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                       '$status $body_bytes_sent "$http_referer" '
                       '"$http_user_agent" "$http_x_forwarded_for" '
                       'rt=$request_time';

        access_log /var/log/nginx/access.log main;
        error_log /var/log/nginx/error.log;

        # Upstream for backend service
        upstream wa_backend {
            server {{ .Values.backendConfig.name }}:8080;
            keepalive 32;
        }

        limit_req_zone $binary_remote_addr zone=general:10m rate=50r/s;
        limit_req_zone $binary_remote_addr zone=api:10m rate=50r/m;

        server {
            listen 8081;
            server_name localhost;
            port_in_redirect off;
            server_name_in_redirect off;
            # Load trusted proxies from mounted secret
            include /etc/nginx/conf.d/trusted-proxies.conf;
            real_ip_header X-Forwarded-For;
            real_ip_recursive on;

            {{- if .Values.route.iprestricted }}
            {{- range .Values.route.ipallowlist }}
            allow {{ . }};
            {{- end }}
            deny all;
            {{- end }}
            

            # Serve static files
            location / {
                limit_req zone=general burst=20 nodelay;
                include /etc/nginx/conf.d/security-headers.conf;
                root /usr/share/nginx/html;
                index index.html index.htm;
                add_header Cache-Control "no-cache, no-store, must-revalidate" always;
                add_header Pragma "no-cache" always;
            }
            
            # Static assets with caching
            location ~* \.(css|js|png|jpg|jpeg|gif|svg|woff|woff2)$ {
                limit_req zone=general burst=50 nodelay;
                include /etc/nginx/conf.d/security-headers.conf;
                root /usr/share/nginx/html;
                expires 30d;
                add_header Cache-Control "public, max-age=2592000, immutable" always;
                add_header X-Content-Type-Options nosniff always;
                try_files $uri =404;
                
        }

            # Proxy API requests to backend
            location /api/ {
                include /etc/nginx/conf.d/security-headers.conf;
                limit_req zone=api burst=5 nodelay;
                add_header Cache-Control "no-cache, no-store, must-revalidate" always;
                add_header Pragma "no-cache" always;
                # Block everything except GET and OPTIONS
                limit_except GET OPTIONS {
                    deny all;
                }
                proxy_pass http://wa_backend/api/;
                proxy_http_version 1.1;
                proxy_set_header Connection "";
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;

                # Remove server info from proxied responses
                proxy_hide_header X-Powered-By;
                proxy_hide_header Server;
                
                proxy_connect_timeout 30s;
                proxy_send_timeout 30s;
                proxy_read_timeout 30s;
                
                # Buffer settings for better performance
                proxy_buffering on;
                proxy_buffer_size 4k;
                proxy_buffers 8 4k;
            }
            
            # Health check endpoint
            location /health {
                access_log off;
                allow 127.0.0.1;
                allow 10.0.0.0/8;
                deny all;
                return 200 "healthy\n";
                add_header Content-Type text/plain;
            }
        }
    }